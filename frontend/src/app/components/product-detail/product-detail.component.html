<div class="product-detail" *ngIf="product">
  <div class="breadcrumb">
    <a routerLink="/">Accueil</a> /
    <a [routerLink]="['/categories', product.category.toLowerCase()]">{{ product.frenchCategory }}</a> /
    <span>{{ product.name }}</span>
  </div>

  <div class="product-content">
    <div class="product-gallery">
      <div class="main-image">
        <img [src]="selectedImage || product.image" [alt]="product.name">
      </div>
      <div class="thumbnail-list" *ngIf="product?.images?.length">
        <div class="thumbnail" 
             *ngFor="let image of product?.images"
             [class.active]="selectedImage === image"
             (click)="changeImage(image)">
          <img [src]="image" [alt]="product.name">
        </div>
      </div>
    </div>

    <div class="product-info">
      <h1>{{ product.name }}</h1>
      
      <div class="price-section">
        <div class="product-price">
          <span class="current-price">{{ product.price | currency:'EUR':'symbol' }}</span>
          <span class="old-price" *ngIf="product?.oldPrice">{{ product.oldPrice | currency:'EUR':'symbol' }}</span>
          <span class="discount-tag" *ngIf="product?.oldPrice">
            -{{ getDiscountPercentage() }}%
          </span>
        </div>
        <div class="stock-status" [class.in-stock]="product.quantity && product.quantity > 0" [class.out-of-stock]="!product.quantity || product.quantity === 0">
          {{ product.quantity && product.quantity > 0 ? 'En stock' : 'Rupture de stock' }}
        </div>
      </div>

      <div class="description">
        <p>{{ product.description }}</p>
      </div>

      <div class="product-actions">
        <div class="quantity-selector">
          <button (click)="decrementQuantity()">-</button>
          <span>{{ quantity }}</span>
          <button (click)="incrementQuantity()">+</button>
        </div>
        <div class="action-buttons">
          <button class="add-to-cart" (click)="addToCart()">
            <i class="fas fa-shopping-cart"></i>
            Ajouter au panier
          </button>
          <button class="wishlist-btn" [title]="isFavorite(product._id) ? 'Retirer des favoris' : 'Ajouter aux favoris'" (click)="toggleFavorite(product._id)" [attr.data-product-id]="product._id">
            <i class="fa-heart" [ngClass]="{'far': !isFavorite(product._id), 'fas': isFavorite(product._id)}"></i>
          </button>
        </div>
      </div>

      <div class="divider"></div>

      <fieldset class="payment-methods">
        <legend class="payment-title">Paiement sécurisé garanti</legend>
        <div class="payment-icons">
          <img src="../../../assets/images/payment/visa.png" alt="Visa">
          <img src="../../../assets/images/payment/mastercard.png" alt="Mastercard">
          <img src="../../../assets/images/payment/amex.png" alt="American Express">
          <img src="../../../assets/images/payment/paypal.png" alt="PayPal">
          <img src="../../../assets/images/payment/applepay.png" alt="Apple Pay">
        </div>
      </fieldset>
    </div>
  </div>

  <div class="product-tabs">
    <div class="tab-navigation">
      <button [class.active]="activeTab === 'description'" (click)="changeTab('description')">
        Description
      </button>
      <button [class.active]="activeTab === 'caracteristiques'" (click)="changeTab('caracteristiques')">
        Caractéristiques
      </button>
      <button [class.active]="activeTab === 'avis'" (click)="changeTab('avis')">
        Avis clients ({{ reviews.length }})
      </button>
    </div>

    <div class="tab-content">
      <div class="tab-pane" [class.active]="activeTab === 'description'">
        <div class="description">
          <p>{{ product.detailDescription }}</p>
        </div>
      </div>

      <div class="tab-pane" [class.active]="activeTab === 'caracteristiques'">
        <div class="characteristics">
          <div class="characteristic-item" *ngIf="product?.material">
            <h4>Matériau</h4>
            <p>{{ product.material }}</p>
          </div>
          <div class="characteristic-item" *ngIf="product?.dimensions">
            <h4>Dimensions</h4>
            <p>{{ product.dimensions }}</p>
          </div>
          <div class="characteristic-item" *ngIf="product?.weight">
            <h4>Poids</h4>
            <p>{{ product.weight }}</p>
          </div>
          <div class="characteristic-item" *ngIf="product?.style">
            <h4>Style</h4>
            <p>{{ product.style }}</p>
          </div>
          <div class="characteristic-item" *ngIf="product?.occasion">
            <h4>Occasion</h4>
            <p>{{ product.occasion }}</p>
          </div>
          <div class="characteristic-item" *ngIf="product?.warranty">
            <h4>Garantie</h4>
            <p>{{ product.warranty }}</p>
          </div>
          <div class="characteristic-item" *ngIf="product?.careInstructions">
            <h4>Entretien</h4>
            <p>{{ product.careInstructions }}</p>
          </div>
        </div>
      </div>

      <div class="tab-pane" [class.active]="activeTab === 'avis'">
        <div class="reviews">
          <!-- Indicateur de chargement -->
          <div *ngIf="loadingReviews" class="loading-reviews">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Chargement des avis...</span>
          </div>

          <!-- Résumé des avis -->
          <div class="reviews-summary" *ngIf="!loadingReviews">
            <div class="average-rating">
              <div class="rating-value">{{ averageRating.toFixed(1) }}</div>
              <div class="stars">
                <i class="fas fa-star" *ngFor="let star of [1,2,3,4,5]"
                   [class.filled]="star <= averageRating"></i>
              </div>
              <div class="review-count">
                {{ reviews.length }} avis
              </div>
            </div>

            <div class="rating-bars">
              <div class="rating-bar" *ngFor="let rating of [5,4,3,2,1]">
                <div class="stars">{{ rating }} <i class="fas fa-star"></i></div>
                <div class="progress-bar">
                  <div class="progress" [style.width.%]="getRatingPercentage(rating)"></div>
                </div>
                <div class="percentage">{{ getRatingPercentage(rating) }}%</div>
              </div>
            </div>
          </div>

          <!-- Liste des avis -->
          <div class="review-list" *ngIf="!loadingReviews && reviews.length > 0">
            <h3 class="reviews-title">
              <i class="fas fa-comments"></i>
              Avis de nos clients
            </h3>
            
            <div class="review-item" *ngFor="let review of reviews; let i = index">
              <!-- Header avec nom, note et date -->
              <div class="review-header">
                <div class="reviewer-info">
                  <span class="reviewer-name">{{ review.userName }}</span>
                  <div class="review-meta">
                    <div class="stars">
                      <i class="fas fa-star" *ngFor="let star of [1,2,3,4,5]"
                         [class.filled]="star <= review.rating"></i>
                    </div>
                    <span class="review-date">
                      {{ formatReviewDate(review.date) }}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- Commentaire -->
              <div class="review-comment">
                <p class="comment-text">{{ review.comment }}</p>
              </div>
            </div>
          </div>

          <!-- Message si aucun avis -->
          <div class="no-reviews" *ngIf="!loadingReviews && reviews.length === 0" style="text-align: center; padding: 40px 20px; color: #666;">
            <i class="fas fa-comment-slash" style="font-size: 48px; color: #ccc; margin-bottom: 15px; display: block;"></i>
            <p style="font-size: 16px; margin: 0; line-height: 1.5;">Aucun avis pour ce produit. Soyez le premier à donner votre avis !</p>
          </div>

          <!-- Formulaire d'ajout d'avis - Visible seulement si l'utilisateur est connecté -->
          <div class="review-form" *ngIf="isUserLoggedIn()">
            <h2 class="review-title">Ajouter un avis</h2>
            <p class="review-notice">Votre adresse email ne sera pas publiée. Les champs obligatoires sont marqués <span class="required">*</span></p>
            
            <form (ngSubmit)="submitReview()" #reviewForm="ngForm">
              <div class="rating-field">
                <label>Votre note <span class="required">*</span></label>
                <div class="stars rating-input">
                  <i class="star fa fa-star" 
                     *ngFor="let star of [1,2,3,4,5]; let i = index"
                     [class.filled]="star <= selectedRating"
                     [class.hover]="star <= selectedRating"
                     (click)="setRating(star)"
                     (mouseenter)="selectedRating = star"
                     (mouseleave)="selectedRating = review.rating"></i>
                </div>
                <div class="rating-error" *ngIf="review.rating === 0 && reviewForm.submitted">
                  Veuillez sélectionner une note
                </div>
              </div>

              <div class="form-group">
                <label>Votre avis <span class="required">*</span></label>
                <textarea 
                  [(ngModel)]="review.comment" 
                  name="reviewText" 
                  required 
                  placeholder="Partagez votre expérience avec ce produit..."
                  maxlength="1000"></textarea>
                <div class="char-count">{{ review.comment.length }}/1000</div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Nom <span class="required">*</span></label>
                  <input 
                    type="text" 
                    [(ngModel)]="review.userName" 
                    name="reviewerName" 
                    required
                    placeholder="Votre nom">
                </div>

                <div class="form-group">
                  <label>E-mail <span class="required">*</span></label>
                  <input 
                    type="email" 
                    [(ngModel)]="review.email" 
                    name="reviewerEmail" 
                    required
                    placeholder="votre@email.com">
                </div>
              </div>

              <div class="form-checkbox">
                <input type="checkbox" name="saveInfo" id="saveInfo">
                <label for="saveInfo">Enregistrer mon nom et mon e-mail pour mon prochain commentaire.</label>
              </div>

              <button type="submit" class="submit-button" [disabled]="submittingReview">
                <span *ngIf="!submittingReview">
                  Soumettre
                  <i class="fas fa-paper-plane"></i>
                </span>
                <span *ngIf="submittingReview">
                  <i class="fas fa-spinner fa-spin"></i>
                  Envoi en cours...
                </span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="related-products" *ngIf="relatedProducts.length > 0">
    <h2>Produits similaires</h2>
    <div class="products-grid">
      <div class="product-card" *ngFor="let relatedProduct of relatedProducts">
        <div class="product-image">
          <img [src]="relatedProduct.image" [alt]="relatedProduct.name">
          <span class="discount-badge" *ngIf="relatedProduct.oldPrice">
            -{{ ((relatedProduct.oldPrice - relatedProduct.price) / relatedProduct.oldPrice * 100) | number:'1.0-0' }}%
          </span>
        </div>
        <div class="product-info">
          <h3 class="product-name">{{ relatedProduct.name }}</h3>
          <div class="product-price">
            <span class="current-price">{{ relatedProduct.price | currency:'EUR':'symbol' }}</span>
            <span class="old-price" *ngIf="relatedProduct.oldPrice">
              {{ relatedProduct.oldPrice | currency:'EUR':'symbol' }}
            </span>
          </div>
          <div class="stock-status" [class.in-stock]="relatedProduct.quantity && relatedProduct.quantity > 0" [class.out-of-stock]="!relatedProduct.quantity || relatedProduct.quantity === 0">
            <i class="fas" [class.fa-check]="relatedProduct.quantity && relatedProduct.quantity > 0" [class.fa-times]="!relatedProduct.quantity || relatedProduct.quantity === 0"></i>
            {{ relatedProduct.quantity && relatedProduct.quantity > 0 ? 'En stock' : 'Rupture de stock' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
