<div class="reviews-container" [@fadeSlideIn]>
  <!-- Header avec titre -->
  <div class="reviews-header">
    <h1>
      Gestion des Avis Clients
    </h1>
  </div>

  <!-- Contrôles de recherche et filtrage -->
  <div class="controls-section">
    <!-- Barre de recherche -->
    <div class="search-container">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          placeholder="Rechercher par nom, email ou commentaire..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        >
      </div>
    </div>
    
    <!-- Filtres organisés -->
    <div class="filters-container">
      <div class="filters-row">
        <!-- Filtre par note -->
        <div class="filter-group">
          <label for="ratingFilter">
            <i class="fas fa-star"></i>
            Note
          </label>
          <select 
            id="ratingFilter" 
            [(ngModel)]="selectedRating" 
            (change)="applyFilters()"
          >
            <option value="">Toutes les notes</option>
            <option value="5">⭐⭐⭐⭐⭐ (5 étoiles)</option>
            <option value="4">⭐⭐⭐⭐ (4 étoiles)</option>
            <option value="3">⭐⭐⭐ (3 étoiles)</option>
            <option value="2">⭐⭐ (2 étoiles)</option>
            <option value="1">⭐ (1 étoile)</option>
          </select>
        </div>

        <!-- Filtre par statut -->
        <div class="filter-group">
          <label for="visibilityFilter">
            <i class="fas fa-eye"></i>
            Statut
          </label>
          <select 
            id="visibilityFilter" 
            [(ngModel)]="selectedVisibility" 
            (change)="applyFilters()"
          >
            <option value="">Tous les statuts</option>
            <option value="visible">✅ Visibles</option>
            <option value="hidden">❌ Masqués</option>
          </select>
        </div>

        <!-- Filtre par produit -->
        <div class="filter-group">
          <label for="productFilter">
            <i class="fas fa-gem"></i>
            Produit
          </label>
          <select 
            id="productFilter" 
            [(ngModel)]="selectedProduct" 
            (change)="applyFilters()"
          >
            <option value="">Tous les produits</option>
            <option *ngFor="let product of products" [value]="product._id">
              {{ product.name }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions-container">
      <button class="btn btn-reset" (click)="resetFilters()" title="Effacer tous les filtres">
        <i class="fas fa-eraser"></i>
        Réinitialiser
      </button>
      <div class="results-count">
        <i class="fas fa-list"></i>
        {{ filteredReviews.length }} avis trouvé{{ filteredReviews.length > 1 ? 's' : '' }}
      </div>
    </div>
  </div>

  <!-- Statistiques -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-number">{{ stats.total }}</div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat-card visible">
      <div class="stat-number">{{ stats.visible }}</div>
      <div class="stat-label">Visibles</div>
    </div>
    <div class="stat-card hidden">
      <div class="stat-number">{{ stats.hidden }}</div>
      <div class="stat-label">Masqués</div>
    </div>
    <div class="stat-card rating">
      <div class="stat-number">{{ stats.averageRating }}/5</div>
      <div class="stat-label">Note moyenne</div>
    </div>
  </div>

  <!-- Actions en lot -->
  <div class="bulk-actions" *ngIf="selectedReviews.size > 0">
    <span class="selected-count">{{ selectedReviews.size }} avis sélectionné(s)</span>
    <div class="bulk-buttons">
      <button class="btn btn-success" (click)="bulkAction('show')">
        <i class="fas fa-eye"></i> Rendre visible
      </button>
      <button class="btn btn-warning" (click)="bulkAction('hide')">
        <i class="fas fa-eye-slash"></i> Masquer
      </button>
      <button class="btn btn-danger" (click)="bulkAction('delete')">
        <i class="fas fa-trash"></i> Supprimer
      </button>
    </div>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="error" class="error-message">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
    <button (click)="error = null" class="close-btn">&times;</button>
  </div>

  <!-- Spinner de chargement -->
  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Chargement des avis...</p>
  </div>

  <!-- Section des avis -->
  <div class="allReviews-card">
    <div *ngIf="!loading" class="reviews-section">
      <h2 class="reviews-title">
        <i class="fas fa-star"></i>
        Avis Clients ({{ filteredReviews.length }})
      </h2>
      
      <div *ngIf="filteredReviews.length === 0" class="no-reviews">
        <p *ngIf="searchTerm || selectedRating || selectedVisibility || selectedProduct">Aucun avis trouvé avec ces critères</p>
        <p *ngIf="!searchTerm && !selectedRating && !selectedVisibility && !selectedProduct">Aucun avis disponible</p>
      </div>
      
      <div *ngIf="filteredReviews.length > 0">
        <div class="table-container">
          <table class="reviews-table">
            <thead>
              <tr>
                <th>
                  <input 
                    type="checkbox" 
                    [checked]="isAllSelected()"
                    (change)="toggleSelectAll()"
                  >
                </th>
                <th (click)="changeSort('userName')" class="sortable">
                  Client
                  <i class="fas fa-sort" 
                     [class.fa-sort-up]="sortBy === 'userName' && sortDirection === 'asc'"
                     [class.fa-sort-down]="sortBy === 'userName' && sortDirection === 'desc'"></i>
                </th>
                <th>Produit</th>
                <th (click)="changeSort('rating')" class="sortable">
                  Note
                  <i class="fas fa-sort" 
                     [class.fa-sort-up]="sortBy === 'rating' && sortDirection === 'asc'"
                     [class.fa-sort-down]="sortBy === 'rating' && sortDirection === 'desc'"></i>
                </th>
                <th>Commentaire</th>
                <th (click)="changeSort('date')" class="sortable">
                  Date
                  <i class="fas fa-sort" 
                     [class.fa-sort-up]="sortBy === 'date' && sortDirection === 'asc'"
                     [class.fa-sort-down]="sortBy === 'date' && sortDirection === 'desc'"></i>
                </th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let review of getPaginatedReviews(); trackBy: trackByReviewId" class="review-row">
                <!-- Checkbox -->
                <td class="review-checkbox-cell">
                  <input 
                    type="checkbox" 
                    [checked]="selectedReviews.has(review._id!)"
                    (change)="toggleSelection(review._id!)"
                  >
                </td>

                <!-- Client -->
                <td class="review-client-cell">
                  <div class="client-info">
                    <div class="client-name">{{ review.userName }}</div>
                    <div class="client-email">{{ review.email }}</div>
                  </div>
                </td>

                <!-- Produit -->
                <td class="review-product-cell">
                  <span class="product-name">{{ getProductName(review.productId) }}</span>
                </td>

                <!-- Note -->
                <td class="review-rating-cell">
                  <div class="rating-container">
                    <div class="stars">
                      <i class="fas fa-star" *ngFor="let star of [1,2,3,4,5]" 
                         [class.filled]="star <= review.rating"></i>
                    </div>
                    <span class="rating-number">({{ review.rating }})</span>
                  </div>
                </td>

                <!-- Commentaire -->
                <td class="review-comment-cell">
                  <div class="comment-preview" [title]="review.comment">
                    {{ review.comment.length > 100 ? (review.comment.substring(0, 100) + '...') : review.comment }}
                  </div>
                </td>

                <!-- Date -->
                <td class="review-date-cell">
                  <span class="date">{{ formatDate(review.date) }}</span>
                </td>

                <!-- Statut -->
                <td class="review-status-cell">
                  <span class="status-badge" [class.status-visible]="review.isVisible" [class.status-hidden]="!review.isVisible">
                    <i class="fas" [class.fa-eye]="review.isVisible" [class.fa-eye-slash]="!review.isVisible"></i>
                    {{ review.isVisible ? 'Visible' : 'Masqué' }}
                  </span>
                </td>

                <!-- Actions -->
                <td class="review-actions-cell">
                  <div class="action-buttons">
                    <button class="btn btn-view" (click)="viewReview(review)" title="Voir">
                      <i class="fas fa-info-circle"></i>
                    </button>
                    <button 
                      class="btn btn-toggle" 
                      (click)="toggleVisibility(review)"
                      [title]="review.isVisible ? 'Masquer' : 'Rendre visible'">
                      <i class="fas" [class.fa-eye-slash]="review.isVisible" [class.fa-eye]="!review.isVisible"></i>
                    </button>
                    <button class="btn btn-delete" (click)="deleteReview(review)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Empty State -->
          <div class="empty-state" *ngIf="!loading && getPaginatedReviews().length === 0">
            <i class="fas fa-star"></i>
            <h3>Aucun avis trouvé</h3>
            <p>Aucun avis ne correspond aux critères sélectionnés.</p>
          </div>

          <!-- Loading State -->
          <div class="loading-state" *ngIf="loading">
            <div class="spinner"></div>
            <p>Chargement des avis...</p>
          </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-section" *ngIf="totalPages > 1">
          <div class="pagination-info">
            Affichage de {{ (currentPage - 1) * itemsPerPage + 1 }} à 
            {{ Math.min(currentPage * itemsPerPage, filteredReviews.length) }} 
            sur {{ filteredReviews.length }} avis
          </div>
          
          <div class="pagination">
            <button 
              class="btn btn-pagination" 
              [disabled]="currentPage === 1"
              (click)="changePage(currentPage - 1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            
            <button 
              class="btn btn-pagination" 
              *ngFor="let page of getPaginationArray(); trackBy: trackByPageNumber"
              [class.active]="currentPage === page"
              (click)="changePage(page)">
              {{ page }}
            </button>
            
            <button 
              class="btn btn-pagination" 
              [disabled]="currentPage === totalPages"
              (click)="changePage(currentPage + 1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de visualisation -->
<div *ngIf="showViewModal" class="modal-overlay" (click)="closeModals()">
  <div class="modal-content modal-view" (click)="$event.stopPropagation()">
    <!-- En-tête du modal -->
    <div class="modal-header">
      <h3>
        <i class="fas fa-eye"></i>
        Détails de l'avis
      </h3>
      <button class="close-btn" (click)="closeModals()" title="Fermer">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Corps du modal -->
    <div class="modal-body" *ngIf="selectedReview">
      <div class="review-details">
        <!-- En-tête avec avatar et informations principales -->
        <div class="review-header">
          <div class="customer-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="customer-info">
            <h5 class="customer-name">{{ selectedReview.userName }}</h5>
            <p class="customer-email">{{ selectedReview.email }}</p>
            <div class="review-meta">
              <span class="review-date">
                <i class="fas fa-calendar-alt"></i>
                {{ formatDate(selectedReview.date) }}
              </span>
              <span class="review-status" [class.status-visible]="selectedReview.isVisible" [class.status-hidden]="!selectedReview.isVisible">
                <i class="fas" [class.fa-eye]="selectedReview.isVisible" [class.fa-eye-slash]="!selectedReview.isVisible"></i>
                {{ selectedReview.isVisible ? 'Visible' : 'Masqué' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Section d'évaluation -->
        <div class="rating-section">
          <div class="rating-display">
            <div class="stars-large">
              <i class="fas fa-star" *ngFor="let star of [1,2,3,4,5]" 
                 [class.filled]="star <= selectedReview.rating"></i>
            </div>
            <span class="rating-text">{{ selectedReview.rating }}/5</span>
          </div>
        </div>

        <!-- Section du commentaire -->
        <div class="comment-section">
          <h4 class="section-title">
            <i class="fas fa-quote-left"></i>
            Commentaire du client
          </h4>
          <div class="comment-content">
            <p>{{ selectedReview.comment }}</p>
          </div>
        </div>

        <!-- Section du produit -->
        <div class="product-section">
          <h4 class="section-title">
            <i class="fas fa-gem"></i>
            Produit concerné
          </h4>
          <div class="product-card">
            <div class="product-info">
              <span class="product-name">{{ getProductName(selectedReview.productId) }}</span>
              <span class="product-id">ID: {{ getProductId(selectedReview.productId) }}</span>
            </div>
          </div>
        </div>

        <!-- Section des détails techniques -->
        <div class="technical-section">
          <h4 class="section-title">
            <i class="fas fa-cog"></i>
            Informations techniques
          </h4>
          <div class="technical-grid">
            <div class="tech-item">
              <label>ID de l'avis</label>
              <span class="tech-value">{{ selectedReview._id }}</span>
            </div>
            <div class="tech-item">
              <label>Date de création</label>
              <span class="tech-value">{{ formatDate(selectedReview.date) }}</span>
            </div>
            <div class="tech-item">
              <label>Statut de visibilité</label>
              <span class="tech-value" [class.visible]="selectedReview.isVisible" [class.hidden]="!selectedReview.isVisible">
                {{ selectedReview.isVisible ? 'Publié' : 'En attente de modération' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Section d'actions rapides -->
        <div class="quick-actions">
          <div class="action-buttons-modal">
            <button 
              class="btn-action moderate" 
              (click)="toggleVisibility(selectedReview!)"
              [class.hide-action]="selectedReview.isVisible"
              [class.show-action]="!selectedReview.isVisible"
              title="{{ selectedReview.isVisible ? 'Masquer cet avis' : 'Publier cet avis' }}">
              <i class="fas" [class.fa-eye]="!selectedReview.isVisible" [class.fa-eye-slash]="selectedReview.isVisible"></i>
              {{ selectedReview.isVisible ? 'Masquer cet avis' : 'Publier cet avis' }}
            </button>
            <button 
              class="btn-action delete" 
              (click)="deleteReview(selectedReview!)"
              title="Supprimer définitivement cet avis">
              <i class="fas fa-trash-alt"></i>
              Supprimer définitivement
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
